<!DOCTYPE html>
<html>
<head>
  <!-- Include meta tag to ensure proper rendering and touch zooming -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Include jQuery Mobile stylesheets -->
   <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

  <style>
#greenbtn {
  background-color: #14b14d;
  border-color: #188237;
  color: #333;
  text-shadow: 0 1px 0 #0e4c18;
}

#mapholder {
  width: 100%;
  height: 300px;
  border: 1px solid red;
}
  </style>
</head>
<body>

<div class="text-center">
  <h1>GPS Test</h1>
  <p>This page tracks your GPS location</p> 
</div>

<div class="container">
  <div class="row">
    <div class="col-sm-12">
      <p id="demo"></p>
      <p id="msg"></p>
      <div id="mapholder"></div>
    </div>
  </div>  
</div>

<script>
var hotspot = {
  //true or false must be lowercase
  makeVisible: true,
  showMap: true,
  mapZoom: 18, //1-20
  corner1Lat: 51.441615,
  corner1Lon:  -2.572170,
  corner2Lat: 51.441356,
  corner2Lon: -2.571422,
  onEnterLoadPage: false,
  onExitLoadPage: false,
  onEnterPlayAudio: false,
  onExitPlayAudio: false
}

</script>


<script>

//global google map and marker
var gMap, marker;
var inHotspot = false;

//Initialise map from maps.googleapis.com/maps/api callback
function initMap() {
  if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          if (hotspot.showMap == true) {
            drawMap(pos);
            drawMarker(pos);  
          };
          if (hotspot.makeVisible == true) {drawHotSpot()};
          watchLocation();
          //check position initally
          checkPosition(pos);
        }, showError, { timeout: 15000, enableHighAccuracy: true });
  } else { 
        alert("Geolocation is not supported by this browser.");
  }
}

function checkPosition(position) {
  var lat = position.coords.latitude;
  var lon = position.coords.longitude;
  console.log("latitude:" + lat + " Longitude:" + lon);
  //  if ( (lat > hotspot.corner1Lat && lat < hotspot.corner2Lat) && (lon > hotspot.corner2Lon && lon < hotspot.corner1Lon) ) {

  if ( (lat > hotspot.corner2Lat && lat < hotspot.corner1Lat) && (lon < hotspot.corner2Lon && lon > hotspot.corner1Lon) ) {
    document.getElementById('msg').innerHTML = "In the hotspot";
    if (localStorage.getItem("hotspotState") != "haveEntered") {
      Alert("entering hotspot");
    };
    localStorage.setItem("hotspotState", "haveEntered");
  } else {
    document.getElementById('msg').innerHTML = "NOT in the hotspot";
    if (localStorage.getItem("hotspotState") == "haveEntered") {
      Alert("exiting hotspot");
      localStorage.setItem("hotspotState", "haveExited");
    };
  };
}

//DRAW MAP INITIALLY
function drawMap(position) {
    lat = position.coords.latitude;
    lon = position.coords.longitude;
    latlon = new google.maps.LatLng(lat, lon)
  
    var myOptions = {
      center:latlon,zoom:hotspot.mapZoom,
      mapTypeId:google.maps.MapTypeId.ROADMAP,
      mapTypeControl:false,
      navigationControlOptions:{style:google.maps.NavigationControlStyle.SMALL}
    }
    //assign global gMap
    gMap = new google.maps.Map(document.getElementById("mapholder"), myOptions);
}

//DRAW MARKER INITIALLY
function drawMarker(position) {
  //assign global marker
  marker = new google.maps.Marker({position:latlon,map:gMap,title:"You are here!"});
}

//DRAW HOTSPOT INITIALLY
function drawHotSpot() {
    var hotspotShape = new google.maps.Rectangle({
      strokeColor: '#FF0000',
      strokeOpacity: 0.8,
      strokeWeight: 2,
      fillColor: '#FF0000',
      fillOpacity: 0.35,
      map: gMap,
      bounds: {
        north: hotspot.corner1Lat,
        south: hotspot.corner2Lat,
        east: hotspot.corner2Lon,
        west: hotspot.corner1Lon
      }
    });
}

//PAN MAP AND MARKER
function panMap(position){
    var lat = position.coords.latitude;
    var lon = position.coords.longitude;
    var center = new google.maps.LatLng(lat, lon);
    // using global variable:
    gMap.panTo(center);
    marker.setPosition(center);
}

//MONITOR LOCATION
function watchLocation() {
    navigator.geolocation.watchPosition(function(pos) {
      displayPositionCoords(pos);
      if (hotspot.showMap == true) {
        panMap(pos);
      };
      checkPosition(pos);
    }, showError, { timeout: 15000, maximumAge: 0, enableHighAccuracy: true }); 
}


//ERROR
function showError(error) {
    switch(error.code) {
        case error.PERMISSION_DENIED:
            alert("User denied the request for Geolocation.");
            break;
        case error.POSITION_UNAVAILABLE:
            alert("Location information is unavailable.");
            break;
        case error.TIMEOUT:
            alert("The request to get user location timed out.");
            break;
        case error.UNKNOWN_ERROR:
            alert("An unknown error occurred.");
            break;
    }
}



function displayPositionCoords(position) {
  var x = document.getElementById("demo");
  x.innerHTML = "Latitude: " + position.coords.latitude + "<br>Longitude: " + position.coords.longitude + "<br><br>";
}




/*function checkHotspot(latCenter, lonCenter, latCurr, lonCurr, dist, map) {
  //10 m = 0001 deg ish
  var radius = dist/100000;
  console.log(radius);
  console.log('centre: ' + latCenter +" , " + lonCenter);
  console.log('current: ' + latCurr +" , " + lonCurr);
  var latCenterN = latCenter + radius;
  var latCenterS = latCenter - radius;
  console.log('edge: N:' + latCenterN + " and S:" + latCenterS );
  var lonCenterE = lonCenter + radius;
  var lonCenterW = lonCenter - radius;
  console.log('edge W:' + lonCenterW + " and E:" + lonCenterE );
  if (latCurr > latCenterS && latCurr < latCenterN ) {
    alert('in the zone');
  } else {
    alert('not in the zone');
  }
  //draw hot spot 
    var rectangle = new google.maps.Rectangle({
      strokeColor: '#FF0000',
      strokeOpacity: 0.8,
      strokeWeight: 2,
      fillColor: '#FF0000',
      fillOpacity: 0.35,
      map: map,
      bounds: {
        north: latCenterN,
        south: latCenterS,
        east: lonCenterE,
        west: lonCenterW
      }
    });
    rectangle.setMap(map);

}*/


</script>



<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBjLeRLiyFRozzXOWwozrC4bVkzGevJTss&callback=initMap">
</script>


</body>
</html>
